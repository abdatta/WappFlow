name: Deploy to server

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
      - name: Install dependencies
        run: npm install
      - name: Run Lint
        run: npm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
      - name: Install dependencies
        run: npm install
      - name: Run Tests
        run: npm test

  build:
    needs: [lint, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
      - name: Install dependencies
        run: npm install
      - name: Run Build
        run: npm run build

  deploy:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Deploy Webhook
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.DEPLOY_URL }}/api/deploy" \
            -H "X-Deploy-Token: ${{ secrets.DEPLOY_TOKEN }}" \
            -H "Content-Type: application/json" \
            --max-time 30)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -ne 202 ]; then
            echo "Deployment trigger failed with status $http_code"
            exit 1
          fi

          echo "Deployment triggered successfully!"

      - name: Wait for Deployment
        run: |
          echo "Polling deployment status with live logs..."
          max_attempts=60  # 5 minutes (60 * 5 seconds)
          attempt=0
          log_index=0
          last_overwritable=""

          while [ $attempt -lt $max_attempts ]; do
            sleep 5
            attempt=$((attempt + 1))

            response=$(curl -s "${{ secrets.DEPLOY_URL }}/api/deploy/status?fromLogIndex=$log_index" \
              --max-time 10 2>/dev/null || echo '{"status":"unreachable"}')

            status=$(echo "$response" | jq -r '.status // "unknown"')
            step=$(echo "$response" | jq -r '.step // ""')
            error=$(echo "$response" | jq -r '.error // ""')
            total_logs=$(echo "$response" | jq -r '.totalLogCount // 0')

            # Process and display new logs
            logs=$(echo "$response" | jq -r '.logs // []')
            log_count=$(echo "$logs" | jq 'length')

            if [ "$log_count" != "null" ] && [ "$log_count" -gt 0 ]; then
              for i in $(seq 0 $((log_count - 1))); do
                log_text=$(echo "$logs" | jq -r ".[$i].text // \"\"")
                is_overwritable=$(echo "$logs" | jq -r ".[$i].overwritable // false")

                if [ -n "$log_text" ]; then
                  # Clear previous overwritable line if any
                  if [ -n "$last_overwritable" ] && [ "$is_overwritable" = "true" ]; then
                    printf "\r\033[K"  # Clear current line
                  fi

                  if [ "$is_overwritable" = "true" ]; then
                    printf "\r%s" "$log_text"
                    last_overwritable="$log_text"
                  else
                    if [ -n "$last_overwritable" ]; then
                      echo ""  # New line after overwritable content
                      last_overwritable=""
                    fi
                    echo "$log_text"
                  fi
                fi
              done

              # Update log index for next poll
              if [ "$total_logs" != "null" ] && [ "$total_logs" -gt 0 ]; then
                log_index=$total_logs
              fi
            fi

            # Print status update
            if [ "$status" = "success" ]; then
              [ -n "$last_overwritable" ] && echo ""  # Ensure newline
              echo ""
              echo "✅ Deployment completed successfully!"
              exit 0
            elif [ "$status" = "failed" ]; then
              [ -n "$last_overwritable" ] && echo ""  # Ensure newline
              echo ""
              echo "❌ Deployment failed: $error"
              exit 1
            elif [ "$status" = "unreachable" ]; then
              echo "⚠️ Server unreachable (may be restarting), waiting..."
            fi
          done

          echo ""
          echo "❌ Deployment timed out after 5 minutes"
          exit 1
